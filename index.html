<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>3D Ball - 50 Levels</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
<style>
  html,body{margin:0;padding:0;height:100%;width:100%;overflow:hidden;font-family:sans-serif;background:#87CEEB;}
  canvas{display:block;position:absolute;left:0;top:0;z-index:5;}
  .mainBtn{position:absolute;top:15px;left:15px;background:#2ecc71;color:white;border:none;padding:12px 20px;border-radius:10px;z-index:1000;cursor:pointer;font-weight:bold;box-shadow:0 4px 0 #27ae60;}
  #menu, #homePage, #levelMenu, #overlay{position:absolute;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;z-index:40;flex-direction:column;}
  #homePage, #levelMenu{background:rgba(135,206,235,0.95);display:none;}
  .btn{width:120px;height:120px;border-radius:50%;font-weight:bold;font-size:16px;position:absolute;box-shadow:0 6px 12px rgba(0,0,0,0.25);color:white;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;text-align:center;transition:0.2s;}
  .btn-start{background:#f1c40f;color:#111;left:50%;top:50%;transform:translate(-50%,-50%);border:4px solid #fff;font-size:20px;}
  .btn-endless{background:#2ecc71;left:50%;top:25%;transform:translate(-50%,-50%);}
  .btn-simple{background:#40E0D0;left:65%;top:45%;transform:translate(-50%,-50%);}
  .simple-active { border: 5px solid white; box-shadow: 0 0 20px #fff; transform: translate(-50%, -50%) scale(1.1) !important; }
  .btn-levels{background:#9b59b6;right:10%;top:50%;transform:translateY(-50%);}
  .btn-home{background:#3498db;left:10%;top:50%;transform:translateY(-50%);}
  .stats-box{background:white; padding:15px; border-radius:20px; text-align:center; margin-bottom:15px; min-width:300px;}
  .color-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;padding:10px;}
  .color-circle{width:45px;height:45px;border-radius:50%;cursor:pointer;border:3px solid #eee;}
  #levelGrid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;max-height:60vh;overflow-y:auto;padding:20px;}
  .lvl-btn{width:60px;height:60px;border-radius:12px;border:none;color:white;font-weight:bold;cursor:pointer;font-size:18px;}
  .locked{background:#555 !important; opacity:0.7; cursor:not-allowed;}
  #rightPanel{position:absolute;right:28px;bottom:36px;z-index:50;display:none;flex-direction:column;align-items:center;gap:15px;}
  #scoreDisplay{font-size:45px;font-weight:bold;color:#fff;text-shadow:2px 2px 5px #000;}
  #jumpBtn{width:110px;height:110px;border-radius:50%;background:#f1c40f;font-weight:bold;font-size:20px;border:none;cursor:pointer;box-shadow:0 6px 0 #b7950b;}
  #overlay{background:rgba(0,0,0,0.9);display:none;z-index:2000;color:white;text-align:center;}
  .back-btn{padding:15px 40px; border-radius:30px; border:none; background:#2ecc71; color:white; font-weight:bold; cursor:pointer;}
</style>
</head>
<body onclick="resumeAudio()">

<button class="mainBtn" onclick="location.reload()">GO TO THE MAIN PAGE</button>

<div id="menu">
  <button class="btn btn-endless" onclick="startMode('endless')">ENDLESS</button>
  <button class="btn btn-start" onclick="handleStartLogic()">START</button>
  <button class="btn btn-simple" id="simpleBtn" onclick="toggleSimple()">SIMPLE</button>
  <button class="btn btn-levels" onclick="showLevels()">LEVELS</button>
  <button class="btn btn-home" onclick="showHome()">STATS</button>
</div>

<div id="homePage">
    <div class="stats-box">
        <h2 style="color:#3498db; margin:5px;">USER STATS</h2>
        <p>Unlocked Levels: <span id="compLevels">1</span> / 50</p>
        <p>High Score: <span id="highScore">0</span></p>
        <div class="color-grid" id="colorGrid"></div>
    </div>
    <button class="back-btn" onclick="hideHome()">BACK</button>
</div>

<div id="levelMenu">
    <h1 style="color:white;">50 LEVELS</h1>
    <div id="levelGrid"></div>
    <button class="back-btn" onclick="hideLevels()">BACK</button>
</div>

<div id="rightPanel">
  <div id="scoreDisplay">0</div>
  <button id="jumpBtn">JUMP</button>
</div>

<div id="overlay">
    <h1 id="message" style="font-size:60px;">GAME OVER</h1>
    <p style="font-size:24px;">Score: <span id="finalScore">0</span></p>
    <button class="back-btn" onclick="location.reload()">MAIN MENU</button>
</div>

<script>
// --- AUDIO SYSTEM ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let grassGain;
function resumeAudio() { if(audioCtx.state === 'suspended') audioCtx.resume(); }
function initGrass() {
    const buf = audioCtx.createBuffer(1, audioCtx.sampleRate * 2, audioCtx.sampleRate);
    const d = buf.getChannelData(0);
    for (let i = 0; i < buf.length; i++) d[i] = Math.random() * 2 - 1;
    const src = audioCtx.createBufferSource();
    src.buffer = buf; src.loop = true;
    const f = audioCtx.createBiquadFilter();
    f.type = 'lowpass'; f.frequency.value = 350;
    grassGain = audioCtx.createGain();
    grassGain.gain.value = 0;
    src.connect(f); f.connect(grassGain); grassGain.connect(audioCtx.destination);
    src.start();
}
function sfx(f, t, d) {
    resumeAudio();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = t; o.frequency.value = f;
    g.gain.setValueAtTime(0.1, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + d);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + d);
}

// --- GAME LOGIC ---
let scene, camera, renderer, ball, obstacles = [], obsMeshes = [];
let player = { x: 0, y: 25, vy: 0, onGround: true, speed: 10 };
let inGame = false, gameOver = false, score = 0, currentMode = 'simple', currentLvlNum = 1;
let isSimpleToggled = false;

let ballColor = localStorage.getItem('ballColor') || '#00BFFF';
let endlessRecord = localStorage.getItem('endlessRecord') || 0;
let unlockedLevel = parseInt(localStorage.getItem('unlockedLevel')) || 1;

function init3D() {
    scene = new THREE.Scene(); scene.background = new THREE.Color(0x87CEEB);
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 1, 10000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);
    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    const sun = new THREE.DirectionalLight(0xffffff, 0.8);
    sun.position.set(100, 500, 100); sun.castShadow = true; scene.add(sun);
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(1000000, 1000), new THREE.MeshPhongMaterial({color: 0x3CB371}));
    ground.rotation.x = -Math.PI / 2; ground.receiveShadow = true; scene.add(ground);
    ball = new THREE.Mesh(new THREE.SphereGeometry(25, 32, 32), new THREE.MeshPhongMaterial({color: ballColor, shininess: 80}));
    ball.castShadow = true; ball.position.y = 25; scene.add(ball);
    initGrass(); setupColorMenu();
}

function setupColorMenu() {
    const colors = [{h: '#00BFFF'}, {h: '#FFFDD0'}, {h: '#FFFF00'}, {h: '#FFD700'}, {h: '#FFFFFF'}, {h: '#000000'}, {h: '#00FF00'}, {h: '#FF0000'}, {h: '#8A2BE2'}, {h: '#FF69B4'}, {h: '#808080'}, {h: '#0000FF'}];
    const grid = document.getElementById('colorGrid');
    colors.forEach(c => {
        const d = document.createElement('div'); d.className = 'color-circle'; d.style.background = c.h;
        d.onclick = () => { ballColor = c.h; ball.material.color.set(c.h); localStorage.setItem('ballColor', c.h); sfx(600, 'sine', 0.1); };
        grid.appendChild(d);
    });
}

function toggleSimple() {
    isSimpleToggled = !isSimpleToggled;
    const btn = document.getElementById('simpleBtn');
    if (isSimpleToggled) { btn.classList.add('simple-active'); sfx(500, 'sine', 0.1); }
    else { btn.classList.remove('simple-active'); }
}

function handleStartLogic() {
    if (isSimpleToggled) startMode('simple-run');
    else startMode('level', unlockedLevel);
}

function update() {
    if(!inGame || gameOver) { if(grassGain) grassGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1); return; }
    player.x += player.speed;
    ball.rotation.z -= player.speed / 25;
    if(!player.onGround) {
        player.vy -= 0.8; player.y += player.vy;
        if(grassGain) grassGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
    }
    if(player.y <= 25) { 
        player.y = 25; player.vy = 0; player.onGround = true;
        if(grassGain) grassGain.gain.setTargetAtTime(0.15, audioCtx.currentTime, 0.2); 
    }
    obstacles.forEach(o => {
        if(Math.abs(player.x - o.x) < 45 && player.y < 85) endGame(false);
        if(!o.p && player.x > o.x) { o.p = true; score++; }
    });
    if((currentMode === 'level' || currentMode === 'simple-run') && score >= obstacles.length) endGame(true);
    ball.position.set(player.x, player.y, 0);
    camera.position.set(player.x - 250, player.y + 120, 0); camera.lookAt(player.x + 500, 25, 0);
}

function endGame(victory) {
    gameOver = true; inGame = false;
    if(!victory) {
        sfx(150, 'sawtooth', 0.5);
        document.getElementById('message').innerText = "GAME OVER";
        if(currentMode === 'endless' && score > endlessRecord) { endlessRecord = score; localStorage.setItem('endlessRecord', endlessRecord); }
    } else {
        sfx(600, 'sine', 0.5);
        document.getElementById('message').innerText = "WELL DONE!";
        if(currentMode === 'level' && currentLvlNum === unlockedLevel && unlockedLevel < 50) { 
            unlockedLevel++; localStorage.setItem('unlockedLevel', unlockedLevel); 
        }
    }
    document.getElementById('finalScore').innerText = score;
    document.getElementById('overlay').style.display = 'flex';
}

function startMode(mode, lvl = 1) {
    resumeAudio(); currentMode = mode; currentLvlNum = lvl;
    inGame = true; gameOver = false; score = 0;
    player.x = 0; player.y = 25; player.vy = 0;
    obsMeshes.forEach(m => scene.remove(m)); obsMeshes = []; obstacles = [];
    const colors = [0xFF0000, 0x00FF00, 0xFFFF00, 0x00FFFF, 0xFF00FF, 0xFFFFFF];
    let count = (mode === 'simple-run') ? 10 : (mode === 'level' ? lvl * 10 : 20000);
    for(let i=0; i<count; i++) {
        let ox = 1000 + i * 550;
        obstacles.push({ x: ox, p: false });
        let m = new THREE.Mesh(new THREE.BoxGeometry(40, 80, 80), new THREE.MeshPhongMaterial({color: colors[Math.floor(Math.random()*colors.length)]}));
        m.position.set(ox, 40, 0); m.castShadow = true; scene.add(m); obsMeshes.push(m);
    }
    // HIDE ALL MENUS IMMEDIATELY
    document.getElementById('menu').style.display = 'none';
    document.getElementById('levelMenu').style.display = 'none';
    document.getElementById('homePage').style.display = 'none';
    document.getElementById('rightPanel').style.display = 'flex';
}

function showHome() { document.getElementById('compLevels').innerText = unlockedLevel; document.getElementById('highScore').innerText = endlessRecord; document.getElementById('menu').style.display = 'none'; document.getElementById('homePage').style.display = 'flex'; }
function hideHome() { document.getElementById('homePage').style.display = 'none'; document.getElementById('menu').style.display = 'flex'; }
function showLevels() {
    document.getElementById('menu').style.display = 'none'; document.getElementById('levelMenu').style.display = 'flex';
    const grid = document.getElementById('levelGrid'); grid.innerHTML = '';
    for(let i=1; i<=50; i++) {
        const b = document.createElement('button'); const isLocked = i > unlockedLevel;
        b.className = 'lvl-btn' + (isLocked ? ' locked' : '');
        b.style.background = isLocked ? '#555' : '#9b59b6'; b.innerText = isLocked ? 'ðŸ”’' : i;
        if(!isLocked) b.onclick = () => startMode('level', i);
        grid.appendChild(b);
    }
}
function hideLevels() { document.getElementById('levelMenu').style.display = 'none'; document.getElementById('menu').style.display = 'flex'; }
document.getElementById('jumpBtn').onmousedown = () => { if(player.onGround && !gameOver) { player.vy = 18; player.onGround = false; sfx(400, 'triangle', 0.2); } };
function animate() { requestAnimationFrame(animate); update(); renderer.render(scene, camera); document.getElementById('scoreDisplay').innerText = score; }
init3D(); animate();
</script>
</body>
</html>
